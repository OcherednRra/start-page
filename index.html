<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Start Page</title>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: rgba(30, 30, 30, 0.8);
            --text-color: #e0e0e0;
            --accent-color: #7289da;
            --checkbox-color: #53ba83;
            --group-header-color: #a86de3;
            --sub-item-indent: 16px;
            --telegram-color: #0088cc;
            --success-color: #4CAF50;
            --warning-color: #FF9800;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            justify-content: flex-end;
            background-image: url('pepe1.jpg');
            background-size: cover;
            background-position: center;
            position: relative;
            overflow: hidden;
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 1;
        }

        .container {
            width: 500px;
            z-index: 2;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            padding: 12px;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            overflow: hidden;
        }

        .top-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .datetime-section {
            background: var(--card-bg);
            padding: 10px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
            text-align: center;
            flex: 1;
        }

        .time {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 2px;
        }

        .date {
            font-size: 14px;
        }

        .search-section {
            background: var(--card-bg);
            padding: 10px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
            flex: 2;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .search-form {
            display: flex;
            width: 100%;
            max-width: 300px;
        }

        .search-input {
            flex: 1;
            padding: 8px 12px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            border-radius: 5px 0 0 5px;
            font-size: 14px;
        }

        .search-button {
            background: var(--accent-color);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 0 5px 5px 0;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--accent-color);
        }

        .routine-section {
            background: var(--card-bg);
            padding: 12px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 65px);
        }

        .routine-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .routine-title {
            font-size: 18px;
            font-weight: bold;
        }

        .routine-tab {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 12px;
            cursor: pointer;
        }

        .routine-tab.active {
            background: var(--accent-color);
        }

        .tabs-container {
            display: flex;
            gap: 5px;
        }

        .save-button {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            margin-bottom: 10px;
            width: 100%;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .save-button:hover {
            background-color: #5d73c7;
        }

        .save-button:active {
            background-color: #4a5da3;
        }

        .telegram-setup {
            background: var(--telegram-color);
        }

        .telegram-setup:hover {
            background-color: #0077b5;
        }

        .button-container {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            margin-bottom: 10px;
        }

        .button-container button {
            flex: 1;
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
            border: none;
            color: white;
        }

        .routine-content {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            overflow: hidden;
            flex-grow: 1;
        }

        .routine-column {
            flex: 1;
            min-width: 220px;
            max-width: calc(50% - 5px);
            display: flex;
            flex-direction: column;
            gap: 10px;
            height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .stats-view {
            display: none;
            flex-direction: column;
            gap: 10px;
            height: calc(100vh - 200px);
            overflow-y: auto;
            padding-right: 5px;
        }

        .stats-view.active {
            display: flex;
        }

        .stats-card {
            background: rgba(50, 50, 60, 0.5);
            border-radius: 6px;
            padding: 12px;
        }

        .stats-card-title {
            font-size: 15px;
            font-weight: bold;
            color: var(--group-header-color);
            border-bottom: 1px solid var(--group-header-color);
            padding-bottom: 3px;
            margin-bottom: 8px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }

        .stat-item {
            background: rgba(60, 60, 70, 0.5);
            padding: 8px;
            border-radius: 5px;
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 3px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
        }

        .progress-container {
            height: 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            margin-top: 3px;
        }

        .progress-bar {
            height: 100%;
            background: var(--accent-color);
            border-radius: 3px;
        }

        .chart-container {
            height: 200px;
            background: rgba(40, 40, 50, 0.5);
            border-radius: 5px;
            margin-top: 10px;
            position: relative;
        }

        .trend-indicator {
            display: inline-block;
            margin-left: 5px;
            font-size: 12px;
        }

        .trend-up {
            color: var(--success-color);
        }

        .trend-down {
            color: var(--warning-color);
        }

        .routine-group {
            background: rgba(50, 50, 60, 0.5);
            border-radius: 6px;
            padding: 8px;
        }

        .group-title {
            font-size: 15px;
            font-weight: bold;
            color: var(--group-header-color);
            border-bottom: 1px solid var(--group-header-color);
            padding-bottom: 3px;
            margin-bottom: 5px;
        }

        .routine-items {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .routine-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sub-item {
            margin-left: var(--sub-item-indent);
        }

        .routine-checkbox {
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid var(--checkbox-color);
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            flex-shrink: 0;
        }

        .routine-checkbox:checked {
            background-color: var(--checkbox-color);
        }

        .routine-checkbox:checked::after {
            content: "✓";
            position: absolute;
            color: white;
            font-weight: bold;
            left: 3px;
            top: -2px;
            font-size: 12px;
        }

        .routine-label {
            font-size: 14px;
            cursor: pointer;
            flex-grow: 1;
        }

        .completed {
            text-decoration: line-through;
            opacity: 0.7;
        }

        .input-field {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            color: var(--text-color);
            font-size: 12px;
            min-width: 70px;
            max-width: 120px;
        }

        .input-field:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--accent-color);
        }

        .input-field.long {
            max-width: 100%;
            width: calc(100% - 26px);
            margin-top: 4px;
            margin-left: 26px;
        }

        select.input-field {
            cursor: pointer;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 100;
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 8px;
            max-width: 400px;
            width: 100%;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 20px;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-input {
            width: 100%;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            border: none;
            border-radius: 4px;
        }

        .form-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--accent-color);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }

        .modal-footer button {
            padding: 8px 15px;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            border: none;
        }

        .btn-cancel {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
        }

        .btn-save {
            background: var(--accent-color);
            color: white;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--accent-color);
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            font-weight: bold;
            z-index: 1000;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s, transform 0.3s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(100, 100, 100, 0.5);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(120, 120, 120, 0.5);
        }
    </style>
</head>
<body>
    <div class="overlay"></div>

    <div class="container">
        <div class="top-bar">
            <div class="datetime-section">
                <div class="time" id="current-time">00:00:00</div>
                <div class="date" id="current-date">April 12</div>
            </div>

            <div class="search-section">
                <form class="search-form" action="https://www.google.com/search" method="get" target="_blank">
                    <input type="text" name="q" class="search-input" placeholder="Search Google..." autocomplete="off">
                    <button type="submit" class="search-button">Search</button>
                </form>
            </div>
        </div>

        <div class="routine-section">
            <div class="routine-header">
                <div class="routine-title">RUTINA</div>
                <div class="tabs-container">
                    <div class="routine-tab active" data-tab="today">Today</div>
                    <div class="routine-tab" data-tab="day">Day Stats</div>
                    <div class="routine-tab" data-tab="week">Week Stats</div>
                    <div class="routine-tab" data-tab="month">Month Stats</div>
                </div>
            </div>
            
            <!-- Button container for both Save and Telegram setup buttons -->
            <div class="button-container">
                <button id="save-button" class="save-button">SAVE ALL DATA</button>
                <button id="telegram-setup" class="save-button telegram-setup">TELEGRAM SETUP</button>
            </div>
            
            <!-- Routine content (original two-column layout) -->
            <div class="routine-content" id="today-view">
                <div class="routine-column" id="routine-column-1">
                    <!-- First column of routine groups -->
                </div>
                <div class="routine-column" id="routine-column-2">
                    <!-- Second column of routine groups -->
                </div>
            </div>
            
            <!-- Day stats view (initially hidden) -->
            <div class="stats-view" id="day-view">
                <div class="stats-card">
                    <div class="stats-card-title">Today's Overview</div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-label">Tasks Completed</div>
                            <div class="stat-value">0/0</div>
                            <div class="progress-container">
                                <div class="progress-bar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Calories</div>
                            <div class="stat-value">0</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Categories</div>
                            <div class="stat-value">0/8</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Success Rate</div>
                            <div class="stat-value">0%</div>
                        </div>
                    </div>
                </div>
                
                <div class="stats-card">
                    <div class="stats-card-title">Category Completion</div>
                    <div class="chart-container" id="day-categories-chart">
                        <!-- Chart will be rendered here -->
                    </div>
                </div>
                
                <div class="stats-card">
                    <div class="stats-card-title">Today's Achievements</div>
                    <div id="day-achievements">
                        <p>No achievements recorded yet</p>
                    </div>
                </div>
            </div>
            
            <!-- Week stats view (initially hidden) -->
            <div class="stats-view" id="week-view">
                <div class="stats-card">
                    <div class="stats-card-title">Weekly Overview</div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-label">Weekly Completion</div>
                            <div class="stat-value">0%</div>
                            <div class="trend-indicator trend-up">+5%</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Best Day</div>
                            <div class="stat-value">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Avg Calories</div>
                            <div class="stat-value">0</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Streak</div>
                            <div class="stat-value">0 days</div>
                        </div>
                    </div>
                </div>
                
                <div class="stats-card">
                    <div class="stats-card-title">Weekly Progress</div>
                    <div class="chart-container" id="week-progress-chart">
                        <!-- Chart will be rendered here -->
                    </div>
                </div>
                
                <div class="stats-card">
                    <div class="stats-card-title">Category Performance</div>
                    <div class="chart-container" id="week-category-chart">
                        <!-- Chart will be rendered here -->
                    </div>
                </div>
            </div>
            
            <!-- Month stats view (initially hidden) -->
            <div class="stats-view" id="month-view">
                <div class="stats-card">
                    <div class="stats-card-title">Monthly Overview</div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-label">Monthly Completion</div>
                            <div class="stat-value">0%</div>
                            <div class="trend-indicator trend-down">-2%</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Perfect Days</div>
                            <div class="stat-value">0</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Habits Maintained</div>
                            <div class="stat-value">0/3</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Best Streak</div>
                            <div class="stat-value">0 days</div>
                        </div>
                    </div>
                </div>
                
                <div class="stats-card">
                    <div class="stats-card-title">30-Day Trend</div>
                    <div class="chart-container" id="month-trend-chart">
                        <!-- Chart will be rendered here -->
                    </div>
                </div>
                
                <div class="stats-card">
                    <div class="stats-card-title">Monthly Habit Calendar</div>
                    <div class="chart-container" id="month-habit-chart">
                        <!-- Chart will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Telegram Setup Modal -->
    <div class="modal" id="telegram-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Telegram Integration</div>
                <button class="modal-close">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">Telegram Bot Token</label>
                <input type="text" class="form-input" id="telegram-token" placeholder="Enter your bot token">
                <small style="display: block; margin-top: 5px; opacity: 0.7;">Create a bot with @BotFather to get a token</small>
            </div>
            <div class="form-group">
                <label class="form-label">Channel/Chat ID</label>
                <input type="text" class="form-input" id="telegram-channel" placeholder="Enter chat ID (@yourchannel)">
            </div>
            <div class="form-group">
                <label class="form-label">Summary Time</label>
                <input type="time" class="form-input" id="telegram-time" value="23:00">
            </div>
            <div class="modal-footer">
                <button class="btn-cancel">Cancel</button>
                <button class="btn-save">Save Settings</button>
            </div>
        </div>
    </div>
    
    <!-- Toast notification -->
    <div class="toast" id="toast-notification"></div>

    <script>
        // Initialize routine groups and items
        const routineData = [
            {
                title: "Meals",
                column: 1,
                items: [
                    { type: "task", label: "Breakfast", checked: false },
                    { type: "task", label: "Lunch", checked: false },
                    { type: "task", label: "Dinner", checked: false },
                    { type: "task", label: "Take meat from freezer", checked: false },
                    { type: "number", label: "Calories", value: "", placeholder: "Calories" }
                ]
            },
            {
                title: "Mental Activities",
                column: 1,
                items: [
                    { type: "task", label: "Reading", checked: false },
                    { type: "task", label: "Mental arithmetic", checked: false },
                    { type: "task", label: "Math", checked: false },
                    { type: "number", label: "Exercises", value: "", placeholder: "Count" },
                    { type: "task", label: "Chess game", checked: false },
                    { type: "select", label: "Result", value: "", options: ["", "Win", "Loss", "Draw"] }
                ]
            },
            {
                title: "Physical Activities",
                column: 1,
                items: [
                    { type: "task", label: "Training", checked: false },
                    { type: "select", label: "Type", value: "", options: ["", "Full-time", "Other"] }
                ]
            },
            {
                title: "Productivity",
                column: 1,
                items: [
                    { type: "task", label: "Studying", checked: false },
                    { type: "text", label: "Learned", value: "", placeholder: "What I learned" },
                    { type: "task", label: "Programming", checked: false },
                    { type: "text", label: "Did", value: "", placeholder: "What I did" }
                ]
            },
            {
                title: "Personal Care",
                column: 2,
                items: [
                    { type: "task", label: "Take a shower", checked: false },
                    { type: "task", label: "Wash hair", checked: false, isSubItem: true },
                    { type: "task", label: "Shave", checked: false, isSubItem: true },
                    { type: "task", label: "Look at sun (5min)", checked: false }
                ]
            },
            {
                title: "Home Care",
                column: 2,
                items: [
                    { type: "task", label: "Air out room", checked: false },
                    { type: "task", label: "Clean room", checked: false }
                ]
            },
            {
                title: "Habits",
                column: 2,
                items: [
                    { type: "task", label: "No cigarettes", checked: false },
                    { type: "task", label: "No alcohol", checked: false },
                    { type: "task", label: "Nofap", checked: false }
                ]
            },
            {
                title: "Creativity",
                column: 2,
                items: [
                    { type: "task", label: "Post for channel", checked: false },
                    { type: "task", label: "Diary entry", checked: false }
                ]
            }
        ];

        // Initialize IndexedDB
        let db;
        const DB_NAME = 'routineTrackerDB';
        const DB_VERSION = 1;
        const ROUTINE_STORE = 'routineData';
        const SETTINGS_STORE = 'settings';

        // Open database connection
        function openDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // Create routine data store
                    if (!db.objectStoreNames.contains(ROUTINE_STORE)) {
                        const store = db.createObjectStore(ROUTINE_STORE, { keyPath: 'date' });
                        store.createIndex('date', 'date', { unique: true });
                    }
                    
                    // Create settings store
                    if (!db.objectStoreNames.contains(SETTINGS_STORE)) {
                        const settingsStore = db.createObjectStore(SETTINGS_STORE, { keyPath: 'id' });
                    }
                };
                
                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log('Database opened successfully');
                    resolve(db);
                };
                
                request.onerror = (event) => {
                    console.error('Database error:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // Save data to IndexedDB
        function saveToDatabase(data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([ROUTINE_STORE], 'readwrite');
                const store = transaction.objectStore(ROUTINE_STORE);
                
                const request = store.put(data);
                
                request.onsuccess = () => {
                    resolve(true);
                };
                
                request.onerror = (event) => {
                    console.error('Error saving to database:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // Load data from IndexedDB by date
        function loadFromDatabase(date) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([ROUTINE_STORE], 'readonly');
                const store = transaction.objectStore(ROUTINE_STORE);
                
                const request = store.get(date);
                
                request.onsuccess = (event) => {
                    resolve(event.target.result);
                };
                
                request.onerror = (event) => {
                    console.error('Error loading from database:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // Load data range from IndexedDB (for statistics)
        function loadDateRange(startDate, endDate) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([ROUTINE_STORE], 'readonly');
                const store = transaction.objectStore(ROUTINE_STORE);
                const index = store.index('date');
                
                const range = IDBKeyRange.bound(startDate, endDate, false, false);
                const request = index.openCursor(range);
                
                const results = [];
                
                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        results.push(cursor.value);
                        cursor.continue();
                    } else {
                        resolve(results);
                    }
                };
                
                request.onerror = (event) => {
                    console.error('Error loading date range:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // Save settings to IndexedDB
        function saveSettings(settings) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([SETTINGS_STORE], 'readwrite');
                const store = transaction.objectStore(SETTINGS_STORE);
                
                const request = store.put(settings);
                
                request.onsuccess = () => {
                    resolve(true);
                };
                
                request.onerror = (event) => {
                    console.error('Error saving settings:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // Load settings from IndexedDB
        function loadSettings(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([SETTINGS_STORE], 'readonly');
                const store = transaction.objectStore(SETTINGS_STORE);
                
                const request = store.get(id);
                
                request.onsuccess = (event) => {
                    resolve(event.target.result);
                };
                
                request.onerror = (event) => {
                    console.error('Error loading settings:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // Function to update date and time
        function updateDateTime() {
            const now = new Date();
            
            // Update time
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            document.getElementById('current-time').textContent = `${hours}:${minutes}:${seconds}`;
            
            // Update date - shorter format to save space
            const options = { month: 'short', day: 'numeric', weekday: 'short' };
            const dateString = now.toLocaleDateString('en-US', options);
            document.getElementById('current-date').textContent = dateString;
            
            // Check if it's time to reset checkboxes (00:00)
            if (hours === '00' && minutes === '00' && seconds === '00') {
                resetRoutineData();
            }
            
            // Check if it's time to send Telegram summary - pass seconds parameter
            checkTelegramSummaryTime(hours, minutes, seconds);
        }

        // Check if it's time to send Telegram summary
        async function checkTelegramSummaryTime(hours, minutes, seconds) {
            try {
                const telegramSettings = await loadSettings('telegram');
                
                if (telegramSettings && telegramSettings.enabled) {
                    const [scheduledHours, scheduledMinutes] = telegramSettings.summaryTime.split(':');
                    
                    if (hours === scheduledHours && minutes === scheduledMinutes && seconds === '00') {
                        console.log('Time to send Telegram summary!');
                        sendTelegramSummary();
                    }
                }
            } catch (error) {
                console.error('Error checking telegram summary time:', error);
            }
        }

        // Function to render routine groups and items
        function renderRoutineGroups() {
            const column1 = document.getElementById('routine-column-1');
            const column2 = document.getElementById('routine-column-2');
            
            column1.innerHTML = '';
            column2.innerHTML = '';
            
            routineData.forEach((group, groupIndex) => {
                const groupElement = document.createElement('div');
                groupElement.className = 'routine-group';
                
                const groupTitle = document.createElement('div');
                groupTitle.className = 'group-title';
                groupTitle.textContent = group.title;
                groupElement.appendChild(groupTitle);
                
                const itemsContainer = document.createElement('div');
                itemsContainer.className = 'routine-items';
                
                group.items.forEach((item, itemIndex) => {
                    if (item.type === 'task') {
                        const routineItem = document.createElement('div');
                        routineItem.className = 'routine-item';
                        if (item.isSubItem) {
                            routineItem.classList.add('sub-item');
                        }
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.className = 'routine-checkbox';
                        checkbox.id = `routine-${groupIndex}-${itemIndex}`;
                        checkbox.checked = item.checked;
                        
                        const label = document.createElement('label');
                        label.className = 'routine-label';
                        label.htmlFor = `routine-${groupIndex}-${itemIndex}`;
                        label.textContent = item.label;
                        
                        if (item.checked) {
                            label.classList.add('completed');
                        }
                        
                        checkbox.addEventListener('change', () => {
                            item.checked = checkbox.checked;
                            if (checkbox.checked) {
                                label.classList.add('completed');
                            } else {
                                label.classList.remove('completed');
                            }
                            
                            // Update day stats in real-time
                            updateDayStats();
                        });
                        
                        routineItem.appendChild(checkbox);
                        routineItem.appendChild(label);
                        itemsContainer.appendChild(routineItem);
                    } else if (item.type === 'number' || item.type === 'text') {
                        const routineItem = document.createElement('div');
                        routineItem.className = 'routine-item';
                        
                        const label = document.createElement('div');
                        label.className = 'routine-label';
                        label.textContent = item.label + ':';
                        
                        const input = document.createElement('input');
                        input.type = item.type === 'number' ? 'number' : 'text';
                        input.className = item.type === 'text' ? 'input-field long' : 'input-field';
                        input.placeholder = item.placeholder || '';
                        input.value = item.value;
                        
                        input.addEventListener('change', () => {
                            item.value = input.value;
                            
                            // Update day stats in real-time for numerical values
                            if (item.type === 'number') {
                                updateDayStats();
                            }
                        });
                        
                        if (item.type === 'text') {
                            routineItem.appendChild(label);
                            itemsContainer.appendChild(routineItem);
                            itemsContainer.appendChild(input);
                        } else {
                            routineItem.appendChild(label);
                            routineItem.appendChild(input);
                            itemsContainer.appendChild(routineItem);
                        }
                    } else if (item.type === 'select') {
                        const routineItem = document.createElement('div');
                        routineItem.className = 'routine-item';
                        
                        const label = document.createElement('div');
                        label.className = 'routine-label';
                        label.textContent = item.label + ':';
                        
                        const select = document.createElement('select');
                        select.className = 'input-field';
                        
                        item.options.forEach(optionText => {
                            const option = document.createElement('option');
                            option.value = optionText;
                            option.textContent = optionText || 'Select...';
                            select.appendChild(option);
                        });
                        
                        select.value = item.value;
                        
                        select.addEventListener('change', () => {
                            item.value = select.value;
                        });
                        
                        routineItem.appendChild(label);
                        routineItem.appendChild(select);
                        itemsContainer.appendChild(routineItem);
                    }
                });
                
                groupElement.appendChild(itemsContainer);
                
                // Add to appropriate column
                if (group.column === 1) {
                    column1.appendChild(groupElement);
                } else {
                    column2.appendChild(groupElement);
                }
            });
        }

        // Function to save all routine data to database
        async function saveAllData() {
            try {
                // Format date as ISO string but truncate to just the date part (YYYY-MM-DD)
                const today = new Date().toISOString().split('T')[0];
                
                // Create entry with current date and all data
                const entry = {
                    date: today,
                    timestamp: new Date().toISOString(),
                    data: JSON.parse(JSON.stringify(routineData)) // Deep copy data
                };
                
                // Save to IndexedDB
                await saveToDatabase(entry);
                
                // Also keep current state in localStorage for backwards compatibility
                localStorage.setItem('currentRoutineData', JSON.stringify(routineData));
                
                // Update the stats views
                updateAllStats();
                
                // Visual feedback
                showToast("Data saved successfully!");
            } catch (error) {
                console.error('Error saving data:', error);
                showToast("Error saving data!", true);
            }
        }

        // Function to load routine data from database or localStorage
        async function loadRoutineData() {
            try {
                // Try to load today's data from IndexedDB
                const today = new Date().toISOString().split('T')[0];
                const todayData = await loadFromDatabase(today);
                
                if (todayData) {
                    // Update our data structure with saved values
                    updateRoutineDataFromSaved(todayData.data);
                    console.log('Loaded today\'s data from database');
                } else {
                    // If no data for today, try localStorage for backwards compatibility
                    const savedData = localStorage.getItem('currentRoutineData');
                    if (savedData) {
                        const parsedData = JSON.parse(savedData);
                        updateRoutineDataFromSaved(parsedData);
                        console.log('Loaded data from localStorage');
                    }
                }
                
                // Update statistics after loading data
                updateAllStats();
            } catch (error) {
                console.error('Error loading routine data:', error);
            }
        }

        // Helper function to update routineData from saved data
        function updateRoutineDataFromSaved(savedData) {
            savedData.forEach((savedGroup, groupIndex) => {
                if (groupIndex < routineData.length) {
                    savedGroup.items.forEach((savedItem, itemIndex) => {
                        if (itemIndex < routineData[groupIndex].items.length) {
                            routineData[groupIndex].items[itemIndex].checked = savedItem.checked;
                            routineData[groupIndex].items[itemIndex].value = savedItem.value;
                        }
                    });
                }
            });
        }

        // Function to reset routine data for a new day
        async function resetRoutineData() {
            try {
                // Before resetting, save one last time with the previous day's data
                await saveAllData();
                
                // Reset all checkboxes and input fields
                routineData.forEach(group => {
                    group.items.forEach(item => {
                        if (item.type === 'task') {
                            item.checked = false;
                        } else {
                            item.value = '';
                        }
                    });
                });
                
                // Save the reset state
                await saveAllData();
                
                // Re-render the UI
                renderRoutineGroups();
                console.log('Reset routine data for new day');
            } catch (error) {
                console.error('Error resetting routine data:', error);
            }
        }

        // Function to update all statistics views
        async function updateAllStats() {
            await updateDayStats();
            await updateWeekStats();
            await updateMonthStats();
        }

        // Update the day statistics view
        async function updateDayStats() {
            try {
                // Calculate stats from current data
                let totalTasks = 0;
                let completedTasks = 0;
                let calories = 0;
                let categoriesWithTasks = 0;
                let completedCategories = 0;
                
                routineData.forEach(group => {
                    let groupHasTasks = false;
                    let allGroupTasksCompleted = true;
                    
                    group.items.forEach(item => {
                        if (item.type === 'task') {
                            totalTasks++;
                            groupHasTasks = true;
                            
                            if (item.checked) {
                                completedTasks++;
                            } else {
                                allGroupTasksCompleted = false;
                            }
                        } else if (item.type === 'number' && item.label === 'Calories' && item.value) {
                            calories = parseInt(item.value) || 0;
                        }
                    });
                    
                    if (groupHasTasks) {
                        categoriesWithTasks++;
                        if (allGroupTasksCompleted) {
                            completedCategories++;
                        }
                    }
                });
                
                // Calculate completion percentage
                const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
                
                // Update the UI
                document.querySelector('#day-view .stat-item:nth-child(1) .stat-value').textContent = 
                    `${completedTasks}/${totalTasks}`;
                
                document.querySelector('#day-view .stat-item:nth-child(1) .progress-bar').style.width = 
                    `${completionRate}%`;
                
                document.querySelector('#day-view .stat-item:nth-child(2) .stat-value').textContent = 
                    calories > 0 ? calories.toString() : '0';
                
                document.querySelector('#day-view .stat-item:nth-child(3) .stat-value').textContent = 
                    `${completedCategories}/${categoriesWithTasks}`;
                
                document.querySelector('#day-view .stat-item:nth-child(4) .stat-value').textContent = 
                    `${completionRate}%`;
                
                // Generate achievements section
                updateDayAchievements(completedTasks, totalTasks, completedCategories);
                
                // If we had actual chart libraries, we would update the chart here
                // For now, we'll just add a placeholder message
                document.getElementById('day-categories-chart').innerHTML = 
                    '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">' +
                    '<p>Category completion visualization would appear here</p>' +
                    '<p>Using a proper chart library like Chart.js</p>' +
                    '</div>';
            } catch (error) {
                console.error('Error updating day stats:', error);
            }
        }

        // Update day achievements section
        function updateDayAchievements(completedTasks, totalTasks, completedCategories) {
            const achievementsElement = document.getElementById('day-achievements');
            
            if (completedTasks === 0) {
                achievementsElement.innerHTML = '<p>No achievements recorded yet</p>';
                return;
            }
            
            let achievements = [];
            
            if (completedTasks === totalTasks) {
                achievements.push('🏆 Perfect day! All tasks completed');
            } else if (completedTasks >= totalTasks * 0.75) {
                achievements.push('🥇 Excellent progress! Most tasks completed');
            } else if (completedTasks >= totalTasks * 0.5) {
                achievements.push('🥈 Good job! Half or more tasks completed');
            } else {
                achievements.push('🥉 Made progress on your daily routine');
            }
            
            if (completedCategories > 0) {
                achievements.push(`✅ Completed all tasks in ${completedCategories} categories`);
            }
            
            // Check specific achievements based on routineData
            routineData.forEach(group => {
                if (group.title === 'Habits') {
                    const allHabitsComplete = group.items.every(item => item.type === 'task' ? item.checked : true);
                    if (allHabitsComplete) {
                        achievements.push('💪 Maintained all your positive habits today!');
                    }
                }
                
                if (group.title === 'Physical Activities') {
                    const didTraining = group.items.some(item => item.type === 'task' && item.label === 'Training' && item.checked);
                    if (didTraining) {
                        achievements.push('🏋️ Stayed active with your training today');
                    }
                }
                
                if (group.title === 'Mental Activities') {
                    const didReading = group.items.some(item => item.type === 'task' && item.label === 'Reading' && item.checked);
                    if (didReading) {
                        achievements.push('📚 Fed your mind with reading today');
                    }
                }
            });
            
            // Display achievements
            achievementsElement.innerHTML = achievements.map(ach => `<p>${ach}</p>`).join('');
        }

        // Update the week statistics view
        async function updateWeekStats() {
            try {
                // Calculate the date range for the past week
                const today = new Date();
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() - 6); // Past 7 days including today
                
                const startDateString = weekStart.toISOString().split('T')[0];
                const endDateString = today.toISOString().split('T')[0];
                
                // Load data for the past week
                const weekData = await loadDateRange(startDateString, endDateString);
                
                if (weekData.length === 0) {
                    // No data for this week yet
                    return;
                }
                
                // Calculate weekly stats
                let weeklyCompletionSum = 0;
                let bestDayCompletion = 0;
                let bestDayName = '-';
                let totalCalories = 0;
                let daysWithData = weekData.length;
                
                weekData.forEach(day => {
                    // Calculate day completion percentage
                    let dayTasks = 0;
                    let dayCompleted = 0;
                    let dayCalories = 0;
                    
                    day.data.forEach(group => {
                        group.items.forEach(item => {
                            if (item.type === 'task') {
                                dayTasks++;
                                if (item.checked) {
                                    dayCompleted++;
                                }
                            } else if (item.type === 'number' && item.label === 'Calories' && item.value) {
                                dayCalories = parseInt(item.value) || 0;
                            }
                        });
                    });
                    
                    const dayCompletion = dayTasks > 0 ? (dayCompleted / dayTasks) * 100 : 0;
                    weeklyCompletionSum += dayCompletion;
                    
                    if (dayCompletion > bestDayCompletion) {
                        bestDayCompletion = dayCompletion;
                        // Get the day name
                        const dayDate = new Date(day.date);
                        bestDayName = dayDate.toLocaleDateString('en-US', { weekday: 'short' });
                    }
                    
                    totalCalories += dayCalories;
                });
                
                // Calculate average weekly completion
                const weeklyAvgCompletion = daysWithData > 0 ? Math.round(weeklyCompletionSum / daysWithData) : 0;
                
                // Calculate average calories
                const avgCalories = daysWithData > 0 ? Math.round(totalCalories / daysWithData) : 0;
                
                // Determine streak
                let streak = 0;
                // Calculate streak logic here - would need consecutive days with good completion
                
                // Update the UI
                document.querySelector('#week-view .stat-item:nth-child(1) .stat-value').textContent = 
                    `${weeklyAvgCompletion}%`;
                
                document.querySelector('#week-view .stat-item:nth-child(2) .stat-value').textContent = 
                    bestDayName;
                
                document.querySelector('#week-view .stat-item:nth-child(3) .stat-value').textContent = 
                    avgCalories.toString();
                
                document.querySelector('#week-view .stat-item:nth-child(4) .stat-value').textContent = 
                    `${streak} days`;
                
                // Placeholder for charts
                document.getElementById('week-progress-chart').innerHTML = 
                    '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">' +
                    '<p>Weekly progress visualization would appear here</p>' +
                    '<p>Showing task completion for each day of the week</p>' +
                    '</div>';
                    
                document.getElementById('week-category-chart').innerHTML = 
                    '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">' +
                    '<p>Category performance visualization would appear here</p>' +
                    '<p>Showing which categories have the best completion rates</p>' +
                    '</div>';
            } catch (error) {
                console.error('Error updating week stats:', error);
            }
        }

        // Update the month statistics view
        async function updateMonthStats() {
            try {
                // Calculate the date range for the past month
                const today = new Date();
                const monthStart = new Date(today);
                monthStart.setDate(today.getDate() - 29); // Past 30 days including today
                
                const startDateString = monthStart.toISOString().split('T')[0];
                const endDateString = today.toISOString().split('T')[0];
                
                // Load data for the past month
                const monthData = await loadDateRange(startDateString, endDateString);
                
                if (monthData.length === 0) {
                    // No data for this month yet
                    return;
                }
                
                // Calculate monthly stats
                let monthlyCompletionSum = 0;
                let perfectDays = 0;
                let daysWithData = monthData.length;
                let bestStreak = 0;
                let currentStreak = 0;
                let habitsData = [];
                
                // Extract habits group for tracking
                const habitsGroup = routineData.find(group => group.title === 'Habits');
                const habitItems = habitsGroup ? habitsGroup.items.filter(item => item.type === 'task') : [];
                
                monthData.forEach(day => {
                    // Calculate day completion percentage
                    let dayTasks = 0;
                    let dayCompleted = 0;
                    
                    // Track habits for this day
                    let dayHabits = [];
                    
                    day.data.forEach(group => {
                        if (group.title === 'Habits') {
                            group.items.forEach(item => {
                                if (item.type === 'task') {
                                    dayHabits.push({
                                        label: item.label,
                                        completed: item.checked
                                    });
                                }
                            });
                        }
                        
                        group.items.forEach(item => {
                            if (item.type === 'task') {
                                dayTasks++;
                                if (item.checked) {
                                    dayCompleted++;
                                }
                            }
                        });
                    });
                    
                    const dayCompletion = dayTasks > 0 ? (dayCompleted / dayTasks) * 100 : 0;
                    monthlyCompletionSum += dayCompletion;
                    
                    // Check for perfect day
                    if (dayCompletion === 100) {
                        perfectDays++;
                        currentStreak++;
                    } else {
                        // Update best streak if current is better
                        if (currentStreak > bestStreak) {
                            bestStreak = currentStreak;
                        }
                        currentStreak = 0;
                    }
                    
                    // Add habits data for tracking
                    habitsData.push({
                        date: day.date,
                        habits: dayHabits
                    });
                });
                
                // Final check for streak
                if (currentStreak > bestStreak) {
                    bestStreak = currentStreak;
                }
                
                // Calculate average monthly completion
                const monthlyAvgCompletion = daysWithData > 0 ? Math.round(monthlyCompletionSum / daysWithData) : 0;
                
                // Calculate habits maintained
                const habitsMaintained = calculateHabitsMaintained(habitsData, habitItems);
                
                // Update the UI
                document.querySelector('#month-view .stat-item:nth-child(1) .stat-value').textContent = 
                    `${monthlyAvgCompletion}%`;
                
                document.querySelector('#month-view .stat-item:nth-child(2) .stat-value').textContent = 
                    perfectDays.toString();
                
                document.querySelector('#month-view .stat-item:nth-child(3) .stat-value').textContent = 
                    `${habitsMaintained}/${habitItems.length}`;
                
                document.querySelector('#month-view .stat-item:nth-child(4) .stat-value').textContent = 
                    `${bestStreak} days`;
                
                // Placeholder for charts
                document.getElementById('month-trend-chart').innerHTML = 
                    '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">' +
                    '<p>30-day trend visualization would appear here</p>' +
                    '<p>Showing completion percentage over the past month</p>' +
                    '</div>';
                    
                document.getElementById('month-habit-chart').innerHTML = 
                    '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">' +
                    '<p>Habit calendar visualization would appear here</p>' +
                    '<p>Showing habit streaks for the past 30 days</p>' +
                    '</div>';
            } catch (error) {
                console.error('Error updating month stats:', error);
            }
        }

        // Calculate how many habits were consistently maintained
        function calculateHabitsMaintained(habitsData, habitItems) {
            if (habitItems.length === 0 || habitsData.length === 0) {
                return 0;
            }
            
            let maintained = 0;
            
            habitItems.forEach(habitItem => {
                const habitName = habitItem.label;
                // Consider habit maintained if completed at least 80% of days
                const daysCompleted = habitsData.filter(day => {
                    const habit = day.habits.find(h => h.label === habitName);
                    return habit && habit.completed;
                }).length;
                
                const completionRate = daysCompleted / habitsData.length;
                if (completionRate >= 0.8) {
                    maintained++;
                }
            });
            
            return maintained;
        }

        // Function to send summary to Telegram
        async function sendTelegramSummary() {
            try {
                const telegramSettings = await loadSettings('telegram');
                
                if (!telegramSettings || !telegramSettings.enabled || 
                    !telegramSettings.botToken || !telegramSettings.chatId) {
                    console.error('Telegram settings not properly configured');
                    return;
                }
                
                // Generate summary text
                const summaryText = await generateDailySummary();
                
                // Send to Telegram
                const response = await fetch(`https://api.telegram.org/bot${telegramSettings.botToken}/sendMessage`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: telegramSettings.chatId,
                        text: summaryText,
                        parse_mode: 'HTML'
                    })
                });
                
                const result = await response.json();
                
                if (!result.ok) {
                    throw new Error('Failed to send Telegram message: ' + result.description);
                }
                
                console.log('Daily summary sent to Telegram successfully');
                
            } catch (error) {
                console.error('Error sending Telegram summary:', error);
            }
        }

        // Generate daily summary text for Telegram
        async function generateDailySummary() {
            let totalTasks = 0;
            let completedTasks = 0;
            let calories = 0;
            const fullyCompletedGroups = [];

            const categoryEmojis = {
                "Meals": "🍽️",
                "Mental Activities": "🧠",
                "Physical Activities": "💪",
                "Productivity": "📚",
                "Personal Care": "🛁",
                "Home Care": "🏠",
                "Habits": "🚭",
                "Creativity": "🎨"
            };

            routineData.forEach(group => {
                let groupTasks = 0;
                let groupCompleted = 0;

                group.items.forEach(item => {
                    if (item.type === 'task') {
                        groupTasks++;
                        totalTasks++;
                        if (item.checked) {
                            groupCompleted++;
                            completedTasks++;
                        }
                    } else if (item.type === 'number' && item.label === 'Calories' && item.value) {
                        calories = parseInt(item.value) || 0;
                    }
                });

                // Добавляем эмодзи группы, только если все задачи выполнены
                if (groupTasks > 0 && groupCompleted === groupTasks) {
                    fullyCompletedGroups.push(categoryEmojis[group.title] || "📋");
                }
            });

            const overallCompletion = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

            let medalEmoji = '😐';
            if (overallCompletion >= 90) medalEmoji = '🥇';
            else if (overallCompletion >= 75) medalEmoji = '🥈';
            else if (overallCompletion >= 50) medalEmoji = '🥉';
            else if (overallCompletion < 30) medalEmoji = '😟';

            // Формируем текст для цитаты с экранированием
            let summaryText = `${medalEmoji} <b>${overallCompletion}%</b>`;
            if (fullyCompletedGroups.length > 0) {
                summaryText += ` ${fullyCompletedGroups.join(" ")}\n`;
            } else {
                summaryText += `\n`;
            }
            summaryText += `🍽 <b>${calories} cal</b>`;

            // Оборачиваем в блок цитаты для MarkdownV2
            summaryText = `\n<blockquote>${summaryText}</blockquote>\n`;

            return summaryText;
        }

        // Handle tab switching
        function handleTabSwitch() {
            const tabs = document.querySelectorAll('.routine-tab');
            const views = [
                document.getElementById('today-view'),
                document.getElementById('day-view'),
                document.getElementById('week-view'),
                document.getElementById('month-view')
            ];
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs
                    tabs.forEach(t => t.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    tab.classList.add('active');
                    
                    // Hide all views
                    views.forEach(view => {
                        if (view.classList.contains('stats-view')) {
                            view.classList.remove('active');
                        } else {
                            view.style.display = 'none';
                        }
                    });
                    
                    // Show selected view
                    const selectedTab = tab.getAttribute('data-tab');
                    if (selectedTab === 'today') {
                        document.getElementById('today-view').style.display = 'flex';
                    } else {
                        document.getElementById(`${selectedTab}-view`).classList.add('active');
                    }
                });
            });
        }

        // Show toast notification
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            
            if (isError) {
                toast.style.backgroundColor = '#f44336';
            } else {
                toast.style.backgroundColor = 'var(--accent-color)';
            }
            
            toast.classList.add('show');
            
            // Hide after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Handle Telegram Setup Modal
        function setupTelegramModal() {
            const telegramButton = document.getElementById('telegram-setup');
            const modal = document.getElementById('telegram-modal');
            const closeBtn = modal.querySelector('.modal-close');
            const cancelBtn = modal.querySelector('.btn-cancel');
            const saveBtn = modal.querySelector('.btn-save');
            
            // Open modal
            telegramButton.addEventListener('click', async () => {
                modal.classList.add('active');
                
                // Load existing settings if available
                try {
                    const telegramSettings = await loadSettings('telegram');
                    if (telegramSettings) {
                        document.getElementById('telegram-token').value = telegramSettings.botToken || '';
                        document.getElementById('telegram-channel').value = telegramSettings.chatId || '';
                        document.getElementById('telegram-time').value = telegramSettings.summaryTime || '23:00';
                    }
                } catch (error) {
                    console.error('Error loading Telegram settings:', error);
                }
            });
            
            // Close modal functions
            const closeModal = () => {
                modal.classList.remove('active');
            };
            
            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            
            // Save settings
            saveBtn.addEventListener('click', async () => {
                const botToken = document.getElementById('telegram-token').value.trim();
                const chatId = document.getElementById('telegram-channel').value.trim();
                const summaryTime = document.getElementById('telegram-time').value;
                
                if (!botToken || !chatId) {
                    showToast('Please fill in all fields', true);
                    return;
                }
                
                try {
                    // Save settings to database
                    await saveSettings({
                        id: 'telegram',
                        botToken,
                        chatId,
                        summaryTime,
                        enabled: true
                    });
                    
                    showToast('Telegram settings saved successfully!');
                    closeModal();
                } catch (error) {
                    console.error('Error saving Telegram settings:', error);
                    showToast('Error saving settings', true);
                }
            });
        }

        // Function to create sample visualizations for the stats charts
        function createSampleVisualizations() {
            // In a real implementation, we would use Chart.js or D3.js
            // Here we'll create simple placeholder visualizations
            
            // Day categories chart
            const dayCategoriesChart = document.getElementById('day-categories-chart');
            dayCategoriesChart.innerHTML = `
                <svg width="100%" height="100%" viewBox="0 0 400 200">
                    <rect x="20" y="20" width="40" height="160" fill="rgba(114, 137, 218, 0.7)" />
                    <rect x="80" y="60" width="40" height="120" fill="rgba(114, 137, 218, 0.7)" />
                    <rect x="140" y="100" width="40" height="80" fill="rgba(114, 137, 218, 0.7)" />
                    <rect x="200" y="30" width="40" height="150" fill="rgba(114, 137, 218, 0.7)" />
                    <rect x="260" y="80" width="40" height="100" fill="rgba(114, 137, 218, 0.7)" />
                    <rect x="320" y="70" width="40" height="110" fill="rgba(114, 137, 218, 0.7)" />
                    <text x="40" y="190" text-anchor="middle" fill="white" font-size="10">Meals</text>
                    <text x="100" y="190" text-anchor="middle" fill="white" font-size="10">Mental</text>
                    <text x="160" y="190" text-anchor="middle" fill="white" font-size="10">Physical</text>
                    <text x="220" y="190" text-anchor="middle" fill="white" font-size="10">Productivity</text>
                    <text x="280" y="190" text-anchor="middle" fill="white" font-size="10">Personal</text>
                    <text x="340" y="190" text-anchor="middle" fill="white" font-size="10">Habits</text>
                </svg>
            `;
            
            // Week progress chart
            const weekProgressChart = document.getElementById('week-progress-chart');
            weekProgressChart.innerHTML = `
                <svg width="100%" height="100%" viewBox="0 0 400 200">
                    <polyline 
                        points="20,180 80,140 140,50 200,90 260,40 320,100 380,60" 
                        stroke="rgba(114, 137, 218, 0.9)" 
                        stroke-width="3" 
                        fill="none" />
                    <circle cx="20" cy="180" r="5" fill="#7289da" />
                    <circle cx="80" cy="140" r="5" fill="#7289da" />
                    <circle cx="140" cy="50" r="5" fill="#7289da" />
                    <circle cx="200" cy="90" r="5" fill="#7289da" />
                    <circle cx="260" cy="40" r="5" fill="#7289da" />
                    <circle cx="320" cy="100" r="5" fill="#7289da" />
                    <circle cx="380" cy="60" r="5" fill="#7289da" />
                    <text x="20" y="195" text-anchor="middle" fill="white" font-size="10">Mon</text>
                    <text x="80" y="195" text-anchor="middle" fill="white" font-size="10">Tue</text>
                    <text x="140" y="195" text-anchor="middle" fill="white" font-size="10">Wed</text>
                    <text x="200" y="195" text-anchor="middle" fill="white" font-size="10">Thu</text>
                    <text x="260" y="195" text-anchor="middle" fill="white" font-size="10">Fri</text>
                    <text x="320" y="195" text-anchor="middle" fill="white" font-size="10">Sat</text>
                    <text x="380" y="195" text-anchor="middle" fill="white" font-size="10">Sun</text>
                </svg>
            `;
            
            // Week category chart
            const weekCategoryChart = document.getElementById('week-category-chart');
            weekCategoryChart.innerHTML = `
                <svg width="100%" height="100%" viewBox="0 0 400 200">
                    <rect x="50" y="20" width="300" height="25" fill="rgba(168, 109, 227, 0.7)" />
                    <rect x="50" y="50" width="250" height="25" fill="rgba(114, 137, 218, 0.7)" />
                    <rect x="50" y="80" width="200" height="25" fill="rgba(83, 186, 131, 0.7)" />
                    <rect x="50" y="110" width="280" height="25" fill="rgba(134, 198, 147, 0.7)" />
                    <rect x="50" y="140" width="150" height="25" fill="rgba(240, 179, 97, 0.7)" />
                    <rect x="50" y="170" width="230" height="25" fill="rgba(247, 141, 167, 0.7)" />
                    <text x="45" y="35" text-anchor="end" fill="white" font-size="10">Habits</text>
                    <text x="45" y="65" text-anchor="end" fill="white" font-size="10">Meals</text>
                    <text x="45" y="95" text-anchor="end" fill="white" font-size="10">Physical</text>
                    <text x="45" y="125" text-anchor="end" fill="white" font-size="10">Mental</text>
                    <text x="45" y="155" text-anchor="end" fill="white" font-size="10">Home</text>
                    <text x="45" y="185" text-anchor="end" fill="white" font-size="10">Personal</text>
                </svg>
            `;
            
            // Month trend chart
            const monthTrendChart = document.getElementById('month-trend-chart');
            monthTrendChart.innerHTML = `
                <svg width="100%" height="100%" viewBox="0 0 400 200">
                    <polyline 
                        points="20,180 40,170 60,150 80,160 100,140 120,130 140,100 160,90 180,110 200,90 220,70 240,80 260,60 280,50 300,60 320,40 340,50 360,30 380,40" 
                        stroke="rgba(114, 137, 218, 0.9)" 
                        stroke-width="2" 
                        fill="none" />
                    <path 
                        d="M20,180 40,170 60,150 80,160 100,140 120,130 140,100 160,90 180,110 200,90 220,70 240,80 260,60 280,50 300,60 320,40 340,50 360,30 380,40 L380,200 20,200 Z" 
                        fill="rgba(114, 137, 218, 0.2)" />
                    <line x1="20" y1="0" x2="20" y2="200" stroke="rgba(255,255,255,0.1)" stroke-width="1" />
                    <line x1="0" y1="200" x2="400" y2="200" stroke="rgba(255,255,255,0.1)" stroke-width="1" />
                    <text x="20" y="15" text-anchor="middle" fill="white" font-size="10">Progress over 30 days</text>
                </svg>
            `;
            
            // Month habit chart
            const monthHabitChart = document.getElementById('month-habit-chart');
            monthHabitChart.innerHTML = `
                <svg width="100%" height="100%" viewBox="0 0 400 200">
                    <!-- First row: No cigarettes -->
                    <text x="10" y="30" fill="white" font-size="10">No cigarettes</text>
                    ${generateHabitCells(50, 20, [1,1,1,1,1,0,1,1,1,1,1,1,0,1,1,1,1,1,1,1])}
                    
                    <!-- Second row: No alcohol -->
                    <text x="10" y="60" fill="white" font-size="10">No alcohol</text>
                    ${generateHabitCells(50, 50, [1,1,1,1,1,1,0,1,1,1,1,1,1,1,0,1,1,1,1,1])}
                    
                    <!-- Third row: Nofap -->
                    <text x="10" y="90" fill="white" font-size="10">Nofap</text>
                    ${generateHabitCells(50, 80, [1,0,1,1,1,1,1,1,0,1,1,1,1,0,1,1,1,1,0,1])}
                    
                    <!-- Days of the month numbers -->
                    ${generateMonthDays(50, 110)}
                </svg>
            `;
            
            // Helper function to generate habit cells
            function generateHabitCells(startX, startY, data) {
                let cells = '';
                for (let i = 0; i < data.length; i++) {
                    const color = data[i] ? 'rgba(83, 186, 131, 0.7)' : 'rgba(255, 99, 71, 0.5)';
                    cells += `<rect x="${startX + i*17}" y="${startY}" width="15" height="15" fill="${color}" rx="2" />`;
                }
                return cells;
            }
            
            // Helper function to generate month day numbers
            function generateMonthDays(startX, startY) {
                let days = '';
                for (let i = 0; i < 20; i++) {
                    days += `<text x="${startX + 7 + i*17}" y="${startY}" fill="white" font-size="8" text-anchor="middle">${i+1}</text>`;
                }
                return days;
            }
        }

        // Initialize the application
        async function initApp() {
            try {
                // Open database connection
                await openDatabase();
                
                // Load saved data
                await loadRoutineData();
                
                // Render the routine groups
                renderRoutineGroups();
                
                // Set up the date/time display
                updateDateTime();
                setInterval(updateDateTime, 1000);
                
                // Set up event handlers
                document.getElementById('save-button').addEventListener('click', saveAllData);
                
                // Set up tab switching
                handleTabSwitch();
                
                // Set up Telegram modal
                setupTelegramModal();
                
                // Create sample visualizations
                createSampleVisualizations();
                
                // Update statistics
                updateAllStats();
                
                console.log('Application initialized');
            } catch (error) {
                console.error('Error initializing app:', error);
                showToast('Error initializing application', true);
            }
        }

        // Run the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>